name: terraform-deployment-with-approval

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy'
        required: true
        type: choice
        options:
          - v1.100
          - v1.200

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Print deployment info
      run: |
        echo "ğŸš€ éƒ¨ç½²ä¿¡æ¯:"
        echo "ç‰ˆæœ¬: ${{ github.event.inputs.version }}"
        echo "è§¦å‘è€…: ${{ github.actor }}"
        echo "åˆ†æ”¯: ${{ github.ref }}"
        echo "æäº¤: ${{ github.sha }}"

    - name: Require Manual Approval
      uses: trstringer/manual-approval@v1
      with:
        secret: ${{ secrets.GITHUB_TOKEN }}
        approvers: "jaka-bo"
        minimum-approvals: 1
        issue-title: "éƒ¨ç½²å®¡æ‰¹è¯·æ±‚ - ç‰ˆæœ¬ ${{ github.event.inputs.version }}"
        issue-body: |
          ## éƒ¨ç½²å®¡æ‰¹è¯·æ±‚
          
          **ç‰ˆæœ¬**: ${{ github.event.inputs.version }}
          **è§¦å‘è€…**: ${{ github.actor }}
          **æ—¶é—´**: ${{ github.event.created_at }}
          **åˆ†æ”¯**: ${{ github.ref }}
          
          ### å®¡æ‰¹æ¸…å•
          - [ ] ç¡®è®¤ç‰ˆæœ¬å·æ­£ç¡®
          - [ ] ç¡®è®¤éƒ¨ç½²æ—¶é—´åˆé€‚
          - [ ] ç¡®è®¤ç›¸å…³æµ‹è¯•å·²é€šè¿‡
          
          è¯·å®¡æ‰¹æ­¤éƒ¨ç½²è¯·æ±‚ã€‚
      

    - name: Execute deployment
      if: success()
      run: |
        echo "âœ… å®¡æ‰¹å·²é€šè¿‡ï¼Œå¼€å§‹æ‰§è¡Œéƒ¨ç½²..."
        echo "éƒ¨ç½²ç‰ˆæœ¬: ${{ github.event.inputs.version }}"
        # è¿™é‡Œæ·»åŠ æ‚¨å®é™…çš„éƒ¨ç½²å‘½ä»¤
        # ä¾‹å¦‚: terraform apply, kubectl apply, ç­‰