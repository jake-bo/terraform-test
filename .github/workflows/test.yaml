name: terraform-deployment-with-approval

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy'
        required: true
        type: choice
        options:
          - v1.100
          - v1.200

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Print deployment info
      run: |
        echo "🚀 部署准备开始"
        echo "版本: ${{ github.event.inputs.version }}"
        echo "触发者: ${{ github.actor }}"
        echo "仓库: ${{ github.repository }}"
        echo "分支: ${{ github.ref_name }}"

    - name: Require Manual Approval
      uses: trstringer/manual-approval@v1
      with:
        # 必需参数：用于 GitHub API 认证
        secret: ${{ secrets.GITHUB_TOKEN }}
        # 审批人列表：将 user1,user2 替换为实际的 GitHub 用户名，用逗号分隔
        approvers: 'jake-bo'
        # 关键参数：设置最低批准人数，例如 2 表示至少需要两人批准
        minimum-approvals: 1
        # 审批请求的标题和正文
        issue-title: "部署审批请求：版本 ${{ github.event.inputs.version }}"
        issue-body: |
          # 部署审批请求
          
          ## 部署信息
          - **版本**: ${{ github.event.inputs.version }}
          - **触发者**: ${{ github.actor }}
          - **仓库**: ${{ github.repository }}
          - **分支**: ${{ github.ref_name }}
          - **触发时间**: ${{ github.event.created_at }}
          
          ## 审批说明
          此操作用于部署新版本到生产环境，请仔细审核以下内容：
          
          ### 需要确认的事项
          - [ ] 版本号正确无误
          - [ ] 相关测试已通过
          - [ ] 部署时间合适
          - [ ] 回滚方案已准备
          
          ### 操作说明
          请在此 Issue 评论区输入以下命令进行审批：
          - **批准**: `/approve`
          - **拒绝**: `/deny`
          
          ⚠️ 注意：需要至少 ${{ inputs.minimum-approvals }} 人批准后，部署流程才会继续执行。
          
          ---
          *此审批请求由 GitHub Actions 自动创建*
        # 可选参数：设置审批超时时间（例如 24小时），避免工作流无限期等待:cite[1]
        

    - name: Execute deployment
      if: success()
      run: |
        echo "✅ 审批已通过，开始执行部署..."
        echo "部署版本: ${{ github.event.inputs.version }}"
        # 这里添加实际的部署命令
        # 例如: 
        # terraform init
        # terraform plan -var="version=${{ github.event.inputs.version }}"
        # terraform apply -auto-approve
        
    - name: Deployment completion
      if: success()
      run: |
        echo "🎉 部署完成!"
        echo "版本 ${{ github.event.inputs.version }} 已成功部署"