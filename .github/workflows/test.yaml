name: terraform-deployment-with-approval

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy'
        required: true
        type: choice
        options:
          - v1.100
          - v1.200

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Print deployment info
      run: |
        echo "ğŸš€ éƒ¨ç½²å‡†å¤‡å¼€å§‹"
        echo "ç‰ˆæœ¬: ${{ github.event.inputs.version }}"
        echo "è§¦å‘è€…: ${{ github.actor }}"
        echo "ä»“åº“: ${{ github.repository }}"
        echo "åˆ†æ”¯: ${{ github.ref_name }}"

    - name: Require Manual Approval
      uses: trstringer/manual-approval@v1
      with:
        # å¿…éœ€å‚æ•°ï¼šç”¨äº GitHub API è®¤è¯
        secret: ${{ secrets.GITHUB_TOKEN }}
        # å®¡æ‰¹äººåˆ—è¡¨ï¼šå°† user1,user2 æ›¿æ¢ä¸ºå®é™…çš„ GitHub ç”¨æˆ·åï¼Œç”¨é€—å·åˆ†éš”
        approvers: 'jake-bo'
        # å…³é”®å‚æ•°ï¼šè®¾ç½®æœ€ä½æ‰¹å‡†äººæ•°ï¼Œä¾‹å¦‚ 2 è¡¨ç¤ºè‡³å°‘éœ€è¦ä¸¤äººæ‰¹å‡†
        minimum-approvals: 1
        # å®¡æ‰¹è¯·æ±‚çš„æ ‡é¢˜å’Œæ­£æ–‡
        issue-title: "éƒ¨ç½²å®¡æ‰¹è¯·æ±‚ï¼šç‰ˆæœ¬ ${{ github.event.inputs.version }}"
        issue-body: |
          # éƒ¨ç½²å®¡æ‰¹è¯·æ±‚
          
          ## éƒ¨ç½²ä¿¡æ¯
          - **ç‰ˆæœ¬**: ${{ github.event.inputs.version }}
          - **è§¦å‘è€…**: ${{ github.actor }}
          - **ä»“åº“**: ${{ github.repository }}
          - **åˆ†æ”¯**: ${{ github.ref_name }}
          - **è§¦å‘æ—¶é—´**: ${{ github.event.created_at }}
          
          ## å®¡æ‰¹è¯´æ˜
          æ­¤æ“ä½œç”¨äºéƒ¨ç½²æ–°ç‰ˆæœ¬åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œè¯·ä»”ç»†å®¡æ ¸ä»¥ä¸‹å†…å®¹ï¼š
          
          ### éœ€è¦ç¡®è®¤çš„äº‹é¡¹
          - [ ] ç‰ˆæœ¬å·æ­£ç¡®æ— è¯¯
          - [ ] ç›¸å…³æµ‹è¯•å·²é€šè¿‡
          - [ ] éƒ¨ç½²æ—¶é—´åˆé€‚
          - [ ] å›æ»šæ–¹æ¡ˆå·²å‡†å¤‡
          
          ### æ“ä½œè¯´æ˜
          è¯·åœ¨æ­¤ Issue è¯„è®ºåŒºè¾“å…¥ä»¥ä¸‹å‘½ä»¤è¿›è¡Œå®¡æ‰¹ï¼š
          - **æ‰¹å‡†**: `/approve`
          - **æ‹’ç»**: `/deny`
          
          âš ï¸ æ³¨æ„ï¼šéœ€è¦è‡³å°‘ ${{ inputs.minimum-approvals }} äººæ‰¹å‡†åï¼Œéƒ¨ç½²æµç¨‹æ‰ä¼šç»§ç»­æ‰§è¡Œã€‚
          
          ---
          *æ­¤å®¡æ‰¹è¯·æ±‚ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*
        # å¯é€‰å‚æ•°ï¼šè®¾ç½®å®¡æ‰¹è¶…æ—¶æ—¶é—´ï¼ˆä¾‹å¦‚ 24å°æ—¶ï¼‰ï¼Œé¿å…å·¥ä½œæµæ— é™æœŸç­‰å¾…:cite[1]
        

    - name: Execute deployment
      if: success()
      run: |
        echo "âœ… å®¡æ‰¹å·²é€šè¿‡ï¼Œå¼€å§‹æ‰§è¡Œéƒ¨ç½²..."
        echo "éƒ¨ç½²ç‰ˆæœ¬: ${{ github.event.inputs.version }}"
        # è¿™é‡Œæ·»åŠ å®é™…çš„éƒ¨ç½²å‘½ä»¤
        # ä¾‹å¦‚: 
        # terraform init
        # terraform plan -var="version=${{ github.event.inputs.version }}"
        # terraform apply -auto-approve
        
    - name: Deployment completion
      if: success()
      run: |
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆ!"
        echo "ç‰ˆæœ¬ ${{ github.event.inputs.version }} å·²æˆåŠŸéƒ¨ç½²"